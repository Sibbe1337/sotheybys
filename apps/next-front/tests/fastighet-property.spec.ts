/**
 * Fastighet (Egendom/Egnahemshus) Property UI Tests
 * 
 * Validates detached house/estate property pages per spec pages 4-5:
 * - Prisuppgifter section with price (no debtPart typically)
 * - Fastighetsinformation section (ownership, propertyId, zoning, buildingRights)
 * - Byggfakta section (year, ventilation, floors, materials)
 * - Hide empty fields rule
 * - Site area in mÂ² or ha (>=10,000 mÂ²)
 * - PropertyTax with â‚¬/Ã¥r suffix
 */

import { test, expect } from '@playwright/test';

const BASE_URL = process.env.BASE || 'http://localhost:3000';
const FASTIGHET_SLUG = process.env.SLUG || 'remmarholmen';

interface FastighetPropertyData {
  streetAddress: string;
  city: string;
  region?: string;
  livingArea?: number;
  totalArea?: number;
  siteArea?: number;
  price: number;
  debtPart?: number;
  debtFreePrice?: number;
  waterFee?: number;
  otherFees?: number;
  propertyTax?: number;
  energyClass?: string;
  energyCertificate?: string;
  // Fastighetsinformation
  siteOwnershipType?: string;
  propertyId?: string;
  zoningSituation?: string;
  buildingRights?: string;
  // Byggfakta
  yearOfBuilding?: number;
  ventilationSystem?: string;
  numberOfFloors?: number;
  buildingMaterial?: string;
  roofType?: string;
}

test.describe('Fastighet Property - Spec Validation (Pages 4-5)', () => {
  
  let apiData: FastighetPropertyData;
  
  test.beforeAll(async () => {
    // Fetch API data in Swedish (per spec)
    const response = await fetch(`${BASE_URL}/api/property/${FASTIGHET_SLUG}?lang=sv`);
    apiData = await response.json();
    console.log('ðŸ“‹ Testing Fastighet property:', apiData.streetAddress);
  });

  test('Prisuppgifter section renders price correctly', async ({ page }) => {
    await page.goto(`${BASE_URL}/property/${FASTIGHET_SLUG}?lang=sv`);
    await page.waitForLoadState('networkidle');
    
    const bodyText = await page.locator('body').textContent() || '';
    
    // Price must be visible
    expect(bodyText).toContain('FÃ¶rsÃ¤ljningspris');
    console.log(`âœ“ FÃ¶rsÃ¤ljningspris visible: ${apiData.price} â‚¬`);
    
    // Debt-free price (if exists - less common for houses)
    if (apiData.debtFreePrice && apiData.debtFreePrice > 0) {
      expect(bodyText).toContain('Skuldfritt');
      console.log(`âœ“ Skuldfritt pris visible: ${apiData.debtFreePrice} â‚¬`);
    }
    
    // Debt part should NOT appear if zero/null (typical for fastighet)
    if (!apiData.debtPart || apiData.debtPart === 0) {
      const hasDebt = bodyText.includes('Skuldandel');
      expect(hasDebt).toBeFalsy();
      console.log(`âœ“ No debt shown (correct for houses)`);
    }
  });

  test('Site area displays correctly: mÂ² or ha for large plots', async ({ page }) => {
    await page.goto(`${BASE_URL}/property/${FASTIGHET_SLUG}?lang=sv`);
    
    if (!apiData.siteArea || apiData.siteArea === 0) {
      console.log('âš  No site area data - skipping test');
      return;
    }
    
    const bodyText = await page.locator('body').textContent() || '';
    
    if (apiData.siteArea >= 10000) {
      // Should display as hectares
      const expectedHa = (apiData.siteArea / 10000).toFixed(2);
      expect(bodyText).toContain('ha');
      console.log(`âœ“ Large plot shows hectares: ${expectedHa} ha (${apiData.siteArea} mÂ²)`);
    } else {
      // Should display as mÂ²
      expect(bodyText).toContain(apiData.siteArea.toString());
      expect(bodyText).toContain('mÂ²');
      console.log(`âœ“ Small plot shows mÂ²: ${apiData.siteArea} mÂ²`);
    }
  });

  test('PropertyTax displays with â‚¬/Ã¥r suffix', async ({ page }) => {
    await page.goto(`${BASE_URL}/property/${FASTIGHET_SLUG}?lang=sv`);
    
    const bodyText = await page.locator('body').textContent() || '';
    
    if (apiData.propertyTax && apiData.propertyTax > 0) {
      // Should show with year suffix
      const hasTaxLabel = bodyText.includes('Fastighetsskatt') || bodyText.includes('KiinteistÃ¶vero');
      expect(hasTaxLabel).toBeTruthy();
      
      const hasYearSuffix = bodyText.includes('â‚¬/Ã¥r') || bodyText.includes('â‚¬/v');
      expect(hasYearSuffix).toBeTruthy();
      
      console.log(`âœ“ Property tax with year suffix: ${apiData.propertyTax} â‚¬/Ã¥r`);
    } else {
      // Row should be hidden
      const hasTaxLabel = bodyText.includes('Fastighetsskatt') || bodyText.includes('KiinteistÃ¶vero');
      expect(hasTaxLabel).toBeFalsy();
      console.log(`âœ“ Property tax row correctly hidden (empty)`);
    }
  });

  test('Fastighetsinformation section shows only non-empty fields', async ({ page }) => {
    await page.goto(`${BASE_URL}/property/${FASTIGHET_SLUG}?lang=sv`);
    
    const bodyText = await page.locator('body').textContent() || '';
    
    // Test siteOwnershipType (Ã„gandet)
    if (apiData.siteOwnershipType && apiData.siteOwnershipType.trim().length > 0) {
      const hasOwnershipLabel = (
        bodyText.includes('Tontin omistus') || // Finnish
        bodyText.includes('Ã„gandet') ||        // Swedish  
        bodyText.includes('Ownership')         // English
      );
      expect(hasOwnershipLabel).toBeTruthy();
      
      // Validate value is Oma/Vuokra or Egen/Hyra
      const validValues = ['Oma', 'Vuokra', 'Egen', 'Hyra', 'Owned', 'Rented'];
      expect(validValues).toContain(apiData.siteOwnershipType);
      
      console.log(`âœ“ Site ownership visible: ${apiData.siteOwnershipType}`);
    } else {
      const hasOwnershipLabel = bodyText.includes('Tontin omistus') || bodyText.includes('Ã„gandet');
      expect(hasOwnershipLabel).toBeFalsy();
      console.log(`âœ“ Site ownership row hidden (empty)`);
    }
    
    // Test propertyId (Fastighetsbeteckning)
    if (apiData.propertyId && apiData.propertyId.trim().length > 0) {
      expect(bodyText).toContain(apiData.propertyId);
      console.log(`âœ“ Property ID visible: ${apiData.propertyId}`);
    } else {
      const hasPropIdLabel = (
        bodyText.includes('KiinteistÃ¶tunnus') ||
        bodyText.includes('Fastighetsbeteckning')
      );
      expect(hasPropIdLabel).toBeFalsy();
      console.log(`âœ“ Property ID row hidden (empty)`);
    }
    
    // Test zoningSituation (Generalplan)
    if (apiData.zoningSituation && apiData.zoningSituation.trim().length > 0) {
      const hasZoningLabel = (
        bodyText.includes('Kaavoitustilanne') ||
        bodyText.includes('PlanlÃ¤ggning')
      );
      expect(hasZoningLabel).toBeTruthy();
      console.log(`âœ“ Zoning visible: ${apiData.zoningSituation}`);
    } else {
      const hasZoningLabel = bodyText.includes('Kaavoitustilanne') || bodyText.includes('PlanlÃ¤ggning');
      expect(hasZoningLabel).toBeFalsy();
      console.log(`âœ“ Zoning row hidden (empty)`);
    }
    
    // Test buildingRights (ByggnadsrÃ¤tt) - critical per spec
    if (apiData.buildingRights && apiData.buildingRights.trim().length > 0) {
      const hasBuildingRightsLabel = (
        bodyText.includes('Rakennusoikeus') ||
        bodyText.includes('ByggnadsrÃ¤tt')
      );
      expect(hasBuildingRightsLabel).toBeTruthy();
      console.log(`âœ“ Building rights visible: ${apiData.buildingRights}`);
    } else {
      const hasBuildingRightsLabel = bodyText.includes('Rakennusoikeus') || bodyText.includes('ByggnadsrÃ¤tt');
      expect(hasBuildingRightsLabel).toBeFalsy();
      console.log(`âœ“ Building rights row HIDDEN per spec (empty)`);
    }
  });

  test('Byggfakta section shows available construction details', async ({ page }) => {
    await page.goto(`${BASE_URL}/property/${FASTIGHET_SLUG}?lang=sv`);
    
    const bodyText = await page.locator('body').textContent() || '';
    
    // Year of building
    if (apiData.yearOfBuilding && apiData.yearOfBuilding > 0) {
      expect(bodyText).toContain(apiData.yearOfBuilding.toString());
      console.log(`âœ“ Year of building: ${apiData.yearOfBuilding}`);
    }
    
    // Ventilation system
    if (apiData.ventilationSystem && apiData.ventilationSystem.trim().length > 0) {
      const hasVentLabel = (
        bodyText.includes('Ilmanvaihto') ||
        bodyText.includes('Ventilation')
      );
      expect(hasVentLabel).toBeTruthy();
      console.log(`âœ“ Ventilation system: ${apiData.ventilationSystem}`);
    } else {
      const hasVentLabel = bodyText.includes('Ilmanvaihto') || bodyText.includes('Ventilationssystem');
      expect(hasVentLabel).toBeFalsy();
      console.log(`âœ“ Ventilation row hidden (empty)`);
    }
    
    // Number of floors
    if (apiData.numberOfFloors && apiData.numberOfFloors > 0) {
      const hasFloorsLabel = (
        bodyText.includes('Kerrosluku') ||
        bodyText.includes('VÃ¥ningar') ||
        bodyText.includes('Floors')
      );
      expect(hasFloorsLabel).toBeTruthy();
      console.log(`âœ“ Number of floors: ${apiData.numberOfFloors}`);
    }
    
    // Building material
    if (apiData.buildingMaterial && apiData.buildingMaterial.trim().length > 0) {
      const hasMaterialLabel = (
        bodyText.includes('Rakennusaine') ||
        bodyText.includes('Byggnadsmaterial')
      );
      expect(hasMaterialLabel).toBeTruthy();
      console.log(`âœ“ Building material: ${apiData.buildingMaterial}`);
    } else {
      console.log(`âš  Building material empty`);
    }
    
    // Roof type
    if (apiData.roofType && apiData.roofType.trim().length > 0) {
      const hasRoofLabel = (
        bodyText.includes('Kattotyyppi') ||
        bodyText.includes('Taktyp')
      );
      expect(hasRoofLabel).toBeTruthy();
      console.log(`âœ“ Roof type: ${apiData.roofType}`);
    } else {
      console.log(`âš  Roof type empty`);
    }
  });

  test('Energy class optional - hidden when empty', async ({ page }) => {
    await page.goto(`${BASE_URL}/property/${FASTIGHET_SLUG}?lang=sv`);
    
    const bodyText = await page.locator('body').textContent() || '';
    
    if (apiData.energyClass && apiData.energyClass.trim().length > 0) {
      const hasEnergyLabel = (
        bodyText.includes('Energiklass') ||
        bodyText.includes('Energialuokka')
      );
      expect(hasEnergyLabel).toBeTruthy();
      console.log(`âœ“ Energy class visible: ${apiData.energyClass}`);
    } else {
      const hasEnergyLabel = bodyText.includes('Energiklass') || bodyText.includes('Energialuokka');
      expect(hasEnergyLabel).toBeFalsy();
      console.log(`âœ“ Energy class row hidden (empty per spec)`);
    }
  });

  test('All required Fastighet fields are present', async ({ page }) => {
    await page.goto(`${BASE_URL}/property/${FASTIGHET_SLUG}?lang=sv`);
    
    const bodyText = await page.locator('body').textContent() || '';
    
    // Core required fields
    expect(bodyText).toContain(apiData.streetAddress);
    expect(bodyText).toContain(apiData.city);
    
    // Price always required
    const priceStr = apiData.price.toString();
    expect(bodyText).toContain(priceStr);
    
    console.log('âœ“ All required fields present: address, city, price');
  });

  test('Swedish language labels used throughout', async ({ page }) => {
    await page.goto(`${BASE_URL}/property/${FASTIGHET_SLUG}?lang=sv`);
    
    const bodyText = await page.locator('body').textContent() || '';
    
    // Check for Swedish labels (not Finnish/English)
    const swedishLabels = [
      'FÃ¶rsÃ¤ljningspris',  // Not "Myyntihinta" or "Sale Price"
      'Stadsdel',          // Not "Kaupunginosa" or "District"
    ];
    
    for (const label of swedishLabels) {
      expect(bodyText).toContain(label);
      console.log(`âœ“ Swedish label present: ${label}`);
    }
  });

  test('Fees display with correct units', async ({ page }) => {
    await page.goto(`${BASE_URL}/property/${FASTIGHET_SLUG}?lang=sv`);
    
    const bodyText = await page.locator('body').textContent() || '';
    
    // Water fee (monthly)
    if (apiData.waterFee && apiData.waterFee > 0) {
      const hasMonthSuffix = bodyText.includes('â‚¬/mÃ¥n') || bodyText.includes('â‚¬/kk');
      expect(hasMonthSuffix).toBeTruthy();
      console.log(`âœ“ Water fee with month suffix: ${apiData.waterFee} â‚¬/mÃ¥n`);
    }
    
    // Other fees (monthly)
    if (apiData.otherFees && apiData.otherFees > 0) {
      const hasMonthSuffix = bodyText.includes('â‚¬/mÃ¥n') || bodyText.includes('â‚¬/kk');
      expect(hasMonthSuffix).toBeTruthy();
      console.log(`âœ“ Other fees with month suffix: ${apiData.otherFees} â‚¬/mÃ¥n`);
    }
  });
});

